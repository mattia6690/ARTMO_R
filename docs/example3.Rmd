---
title: "Spatial Link"
author: "Mattia Rossi"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

This Tutorial is about linking the ARTMO output with Raster Data in R.
ARTMO does not provide a unified workflow on how to store Spatial Rasters and how to join Raster Data and model output.

Therefore the steps for combining Model output and Spatial Data cannot be established automatically but has to be manually linked after each iteration.
This Tutorial draws a **possible approach for the analysis** of combined modelled and spatial data. The following example **links the MySQL Table with Raster Files and Shapefiles**. The rasters consist of ARTMO Outputs and the Shapefiles have been created a-priori. They are stored as [simple Features (sf)](https://github.com/r-spatial/sf). This format is recommended since it allows to comprise diverse geometric types (points, shapefiles etc.) and to easily link them to tibbles and data frames.

# Essentials

Analogous to the previous tutorial the first step consists in loading the necessary functions and packages.

```{r e1,warning=FALSE,message=FALSE}
source("../R/Essentials.R")
source("../R/Fun_Spatial.R")
```

# Link data
In a second step we need the Information about which dataset we are analyzing (MLRA, CF ...) as well as the directory we are aiming to
```{r e2}

dir<-"C:/ARTMO"

stat<-readRDS("./data/demo.rds") %>% 
  filter(!map_lgl(Results, is.null)) 
stat.spat<-SpatDir(stat,dir)

```

What we see is that each entry in the Table is provided with a unique Store.ID. This ID is linked to a Model. This allows to connect each iteration with one Model. It is recommended to use this structurization to store the Spatial Files (or basically every other output from ARTMO)in a subfolder with the StoreID. It is highly recommended to **STORE the Rasters** in the respective folders.

Example. If we want to use both `noise = 5` algorithm as the `algorithm = Exponential` as variables the folder structure should be the following. I fyou want you can use the `dircheckup` function for creating the folders automatically.

## Create Subdirectory

```{r}

model.s <-"Model1"
algo.s  <-"Exponential"
noise.s <-5

subset<-stat.spat %>% filter(Model==model.s & algorithm==algo.s & noise==noise.s) 
folder<-subset$SpatDir
dircheckup(folder)

folder

```


# Raster Data

Now we want to see which of the following folders contain raster information. Therefore we parse each of the Location and search for generated Raster

```{r}

stat.spat.ras<-SpatDir(stat,dir,addraster = T)

stat.spat.ras
```

Do we really have integrated the Raster in the Table???? -> YES!!

```{r}
pl<-stat.spat.ras$Rasters[[1]]
plot(pl)

```

But watch out! It is important to add the Date to the Shapefile

```{r}

dates<-c("2017-05-24","2017-05-31","2017-06-07","2017-06-15")
dates<-as.Date(dates)

stat.spat.ras$AcqDate<-dates

```

# Spatial Data

But we also need to know about the we need to know about the Simple features/ Shapefiles. These help to evaluate the actual performance of the Model and Validate it. A possible SF File could be like the one here below. Since the Simple Features work as a tibble with geographical annotation it is possible to **add many different properties** such as the date of acquisition, the station, its coordinates or the actual measurement 

```{r,echo=F,warnings=F}
ARTMOdir<-"U:/S2_LAI"
gpdata.file<-paste0(ARTMOdir,"/Validation_Tables/Metrics_S2_ByBand_LAI_190918.rds")
gpsdata<- gpdata.file %>% 
  readRDS %>% 
  st_as_sf %>% 
  dplyr::select(Station,Date,OP1,meanLAI) %>% 
  filter(Station=="Domef1500") %>% 
  rename(AcqDate=Date)

```

```{r}
print(gpsdata,n=5)
plot(gpsdata)
```

# Connect Datasets

The Simple Feature is simply added to the Database we generated with the steps a-priori as a new columns. It is again considerated as a nested element 


```{r}

stat.spat.ras.sf<-stat.spat.ras %>% 
  mutate(Features=map(AcqDate,function(x){
    
    gpsdata %>% filter(AcqDate==x) %>% return(.)
    
  }))

stat.spat.ras.sf

```

And a plot on how the Shapefiles and the Raster Files are connected now:

```{r}

ras<-stat.spat.ras.sf$Rasters[[1]][[1]]
shp<-stat.spat.ras.sf$Features[[1]]

plot(ras)
plot(st_geometry(shp),fill="black",add=T)

```

# Plot

Now we can use the Raster and Feature from each of the Files to extract the Raster values at the exact same location as the Points are and combine them to the actual measurements in the Spatial Data Frame

```{r}
measure<-"meanLAI"

result<-add.spatialresults(stat.spat.ras.sf,measuredCol = measure)


print(result)
```

To finish we compare the Modelled Results to the ones Measured in the Field at a given Location

```{r,warning=F}
selection<-result %>% select(RasName,Features,Spat.Result) %>% unnest %>% 
  mutate(Date=as.character(AcqDate))

g1<-ggplot(selection,aes(Simulated,Measured,color=Date))+ theme_bw()+
  geom_point()+
  geom_smooth(method="lm",se=F,col="brown")+
  geom_abline(intercept=0,slope=1,linetype="dotted")+
  facet_wrap(.~Station,ncol=2)+
  xlab("Simulated LAI")+ylab("Measured LAI")+
  ylim(c(0,10))+
  xlim(c(0,10))
g1
```

Or make it interactive using the ggplotly package

```{r,message=F,warning=F}

library("plotly")
ggplotly(g1)

```

