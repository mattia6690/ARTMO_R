---
title: "First ARTMO LUT Inversion Simulations"
author: "Mattia Rossi"
output:
  html_document: default
---

This markdown is used for documenting the ARTMO simulations for LAI retrieval during my period at the IPL, LEO in 2018.
I separated the codes by simulation and added the code necessary to plot the results and to document strength and weaknesses of the simulation approach.
Each iteration will be calculated in the [R directory](https://github.com/mattia6690/ARTMO_R/tree/master/R) of this repository. The visualization and discussion of the results will be done within the [Documentation directory](https://github.com/mattia6690/ARTMO_R/tree/master/Documentation) sparsed across diverse RMarkdowns

## Setup of Environment

The working environment can be set up in any directory 

```{r,cache=T,warning=F,message=F}
ARTMOdir<-"K:/SentinelVegetationProducts/S2_LAI"
ARTMOdir.ss<-paste0(ARTMOdir,"/Subsets")
ARTMOdir.in<-paste0(ARTMOdir,"/ARTMO_Inversion")

source("../R/Essentials.R")

```

## First simulation

The first model I tried has the following specs:
* PROSAIL LUT inversion
* N 0-3 by 1 
* Chl 0-100 by 10
* LAI 0-8 by 0.1
* Angle 20-90 by 25
* 30000 Simulations
* 10 S-2 bands. All bands resampled to 10 m and the 60m band is excluded
* Exponential COST Function with 1 sample: RMSE: 1.1 and R^[2]$ of around 0-8. The second best COST function is are both RMSE functions

We used the **ARTMO_inversion_images.R** function to process and store the combination of raster and point data to extract and compare the simulated to the measured LAI values. The results are imported as:

```{r,cache=T}
library("tibble")
directory<- "2509_Prosail_Inversion_30000_10Bands_v1"

data<- readRDS(file=paste0(ARTMOdir.in,"/",directory,".rds")) 
data<- as.tibble(data)
data

```

And now the Plots of the Simulated vs the Measured LAI retrieved by this simulation:
```{r,cache=T}
eq1<-data %>% 
  group_by(Station) %>% nest %>% 
  mutate(Lm=map(data,function(l) lm(l$Simulated~l$Measured))) %>% 
  mutate(Eq=map_chr(Lm,r2.equation)) %>% 
  dplyr::select(Station,Eq)

g1<-ggplot(data,aes(Simulated,Measured,color=as.character(Date)))+ theme_bw()+
  geom_point()+
  geom_smooth(method="lm",se=F,col="brown")+
  geom_abline(intercept=0,slope=1,linetype="dotted")+
  scale_color_discrete(name = "Date")+
  facet_wrap(.~Station,ncol=2)+
  xlab("Simulated LAI")+ylab("Measured LAI")+
  ylim(c(0,10))+
  xlim(c(0,10))

g1<-g1+geom_text(data=eq1,aes(x=3,y=10,label=Eq,family="serif"),color="black",parse=T)

plot(g1)
```



